#!/usr/bin/env bash
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
# # #  # # #  #      # # #  # # #
  #    #      #      #   #  # 
  #    # #    #      # #    # 
  #    #      #      #  #   #  
  #    # # #  # # #  #   #  # # # 
#~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~#
# ~ default shell customisations ~
# Note: this file will be overwritten and is therefore recommended not to change


# # # PROMPT SETUP # # # (must be first)
if [ ! -f ~/.p10k.zsh ] ; then #fallback to python prompt if file not exist
	# Use python powerline?
	POWERLINE_BASH_CONTINUATION=1
	POWERLINE_BASH_SELECT=1
	powerline-daemon -q
	. $PY_SITE_PKGS/powerline/bindings/zsh/powerline.zsh
else
	# Use p10k?
	POWERLEVEL9K_DISABLE_CONFIGURATION_WIZARD=true
#	. ~/.tel/shell/prompt/powerlevel10k.zsh-theme
	. ~/.p10k.zsh
fi
# Force prompt to stay at bottom of screen
printf '\n%.0s' {1..100}
alias clear="(clear && printf '\n%.0s' {1..100})"
alias reset="(reset && printf '\n%.0s' {1..100})"
alias tput reset="(tput reset && printf '\n%.0s' {1..100})"

# Below is appended to partial lines in zsh, default is %, empty is more pretty
PROMPT_EOL_MARK='' 

# # # END PROMPT SETUP # # # 





# # # SOURCE CONFIGS ETC  # # #
. ~/.tel/scripts/readconfigs.sh 	# get user settings
. ~/.tel/.tel_aliases 			# load tel aliases
. ~/.aliases 				# load user aliases
# load external aliases (impervious to deletion upgrade etc)
[[ -f ~/storage/shared/tel/tel_personal.sh ]] && . ~/storage/shared/tel/tel_personal.sh

# # # END SOURCE CONFIGS ETC # # #





# # # SETUP PATHS # # # 
export PATH=/data/data/com.termux/files/usr/bin:/data/data/com.termux/files/usr/bin/applets:~/.tel/bin:/data/data/com.termux/files/home/.local/bin

export PY_SITE_PKGS="$(python -m site --user-site)" #only works in python 3.9+ otherwise this may need to be set manually



# # # CUSTOMISE ZSH # # #
set -K # disables ! events in zsh to allow for bangs in tel-search, eg 's !!wiki mycelium'
# ZSH widgets
#zle -N history-substring-search-up
#zle -N history-substring-search-down
# ZSH Plugins
#source ~/.tel/shell/plugins/zsh-syntax-highlighting/zsh-syntax-highlighting.zsh # must be first
#source ~/.tel/shell/plugins/zsh-history-substring-search/zsh-history-substring-search.zsh
#source ~/.tel/shell/plugins/zsh-autosuggestions/zsh-autosuggestions.zsh
# Bindkeys
#bindkey '^[[A' history-substring-search-up
#bindkey '^[[B' history-substring-search-down
# Completion #
zstyle ":completion:*:git-checkout:*" sort false
zstyle ':completion:*:descriptions' format '[%d]'
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'exa -1 --color=16 $realpath'
# # # Oh My Zsh # # # 
DISABLE_UPDATE_PROMPT=true 
DISABLE_AUTO_UPDATE=true
# ZSH History
HISTSIZE=40000
SAVEHIST=20000
HISTFILE=~/.zsh_history
setopt INC_APPEND_HISTORY
setopt SHARE_HISTORY # share history across zsh instances
setopt HIST_IGNORE_ALL_DUPS
setopt HIST_IGNORE_SPACE # prepend a space to commands means it is not logged to history
autoload -U compinit && compinit # reload completion (for zsh-completions plugin)

# # # END CUSTOMISE ZSH # # #

# # # CUSTOMISE FZF # # #
export FZF_DEFAULT_COMMAND='fd --type f --hidden --follow --exclude .git' # allow finding of dot files
export FZF_BASE=$HOME/../usr/bin/fzf
[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh # load fzf bindings
# # # END CUSTOMISE FZF # # # 


# # # TERMINAL BEHAVIOUR # # #
if [ ! -z $SSH_CONNECTION ]; then # Default SSH behaviour
	termux-toast '[TEL]: User connected through SSH'
	(am start --user 0 -n com.termux/com.termux.app.TermuxActivity > /dev/null 2>&1) # Bring tel to foreground
	export TERM=xterm-256color # set generic SSH TERM profile
fi
export TERMINFO='~/../usr/share/terminfo/' # here you can play other term info files, already supplied is kitty-term

